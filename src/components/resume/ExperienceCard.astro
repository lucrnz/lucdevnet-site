---
import {
  prettyPrintDateDifference,
  roundDateDifference,
  dateDifference
} from "~/helpers/DateDifference";
import {
  formatDateTime,
  DateTimeFormattingConfig
} from "~/helpers/formatDateTime";
import type { Skill } from "~/types/resume/Skill";
import type { JobTitle } from "~/types/resume/JobTitle";
import type { JobCompany } from "~/types/resume/JobCompany";
import type { JobLocation } from "~/types/resume/JobLocation";
import type { JobLocationType } from "~/types/resume/JobLocationType";
import BulletPoints from "./BulletPoints.astro";
import ResumeCardGrid from "./ResumeCardGrid.astro";

export interface Props {
  title: JobTitle;
  companyName: JobCompany;
  startDate: Date;
  endDate?: Date;
  location: JobLocation;
  locationType: JobLocationType;
  bulletPoints: string[];
  skills: Skill[];
}

const {
  title,
  companyName,
  startDate,
  endDate,
  location,
  locationType,
  bulletPoints,
  skills
} = Astro.props as Props;

const showEndDate = endDate !== undefined;

const timeTotal = prettyPrintDateDifference(
  roundDateDifference(dateDifference(startDate, endDate ?? new Date()))
);

const startDateRendered = formatDateTime(
  startDate,
  DateTimeFormattingConfig.MonthYearOnly
);

const endDateRendered = endDate
  ? formatDateTime(endDate, DateTimeFormattingConfig.MonthYearOnly)
  : "";
---

<ResumeCardGrid>
  <Fragment slot="left-side">
    <div class="lg:max-w-[40ch] h-full flex flex-col mb-2 gap-2 print:max-w-[unset]">
      <h4 class="text-xl font-medium mb-4 font-display print:font-serif print:font-bold">{title}</h4>
      <span class="flex items-center gap-2">
        <svg aria-label="Company icon" class="print:hidden" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path fill="currentColor" d="M18 15h-2v2h2m0-6h-2v2h2m2 6h-8v-2h2v-2h-2v-2h2v-2h-2V9h8M10 7H8V5h2m0 6H8V9h2m0 6H8v-2h2m0 6H8v-2h2M6 7H4V5h2m0 6H4V9h2m0 6H4v-2h2m0 6H4v-2h2m6-10V3H2v18h20V7z"/></svg>
        <span class="print:font-bold">{companyName}</span>
      </span>
      {
        endDate && (
          <span class="flex items-center gap-2">
            <svg aria-label="Clock icon" class="print:hidden" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path fill="currentColor" d="M12 20a8 8 0 0 0 8-8a8 8 0 0 0-8-8a8 8 0 0 0-8 8a8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10a10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67l-.75 1.23L11 13V7z"/></svg>
            {timeTotal}
          </span>
        )
      }
      {
        !endDate && (
          <span class="flex items-center gap-2">
            <svg aria-label="Clock icon" class="print:hidden" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path fill="currentColor" d="M12 20a8 8 0 0 0 8-8a8 8 0 0 0-8-8a8 8 0 0 0-8 8a8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10a10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67l-.75 1.23L11 13V7z"/></svg>
            <time-difference-wrapper
              data-start={startDate.toJSON()}
              data-end="now"
            />
          </span>
        )
      }
      <span class="flex items-center gap-2">
        <svg aria-label="Calendar icon" class="print:hidden" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path fill="currentColor" d="M12 12h5v5h-5zm7-9h-1V1h-2v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2m0 2v2H5V5zM5 19V9h14v10z"/></svg>
        {
          showEndDate
            ? `${startDateRendered} to ${endDateRendered}`
            : `Started: ${startDateRendered}`
        }
      </span>
      <span class="flex items-center gap-2">
        <svg aria-label="Location icon" class="print:hidden" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 32 32"><path fill="currentColor" d="M16 18a5 5 0 1 1 5-5a5.006 5.006 0 0 1-5 5m0-8a3 3 0 1 0 3 3a3.003 3.003 0 0 0-3-3"/><path fill="currentColor" d="m16 30l-8.436-9.949a35 35 0 0 1-.348-.451A10.9 10.9 0 0 1 5 13a11 11 0 0 1 22 0a10.9 10.9 0 0 1-2.215 6.597l-.001.003s-.3.394-.345.447ZM8.813 18.395s.233.308.286.374L16 26.908l6.91-8.15c.044-.055.278-.365.279-.366A8.9 8.9 0 0 0 25 13a9 9 0 1 0-18 0a8.9 8.9 0 0 0 1.813 5.395"/></svg>
        {location} · {locationType}
      </span>
      {
        (
          <span class="flex items-center">
            <span role="list">
              <div class="inline-block">
                <svg aria-label="Wrench icon" class="inline-block print:hidden mr-[0.3ch]" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path fill="currentColor" d="m21.71 15.58l-4.52-4.51a6.85 6.85 0 0 0 .14-1.4A7.67 7.67 0 0 0 6.42 2.72a1 1 0 0 0-.57.74a1 1 0 0 0 .28.88l4.35 4.34l-1.8 1.8l-4.34-4.35a1 1 0 0 0-.88-.27a1 1 0 0 0-.74.56a7.67 7.67 0 0 0 7 10.91a6.85 6.85 0 0 0 1.4-.14l4.51 4.52a1 1 0 0 0 1.42 0a1 1 0 0 0 0-1.42l-4.9-4.9a1 1 0 0 0-.95-.26a5.88 5.88 0 0 1-1.48.2A5.67 5.67 0 0 1 4 9.67a6 6 0 0 1 .08-1L8 12.6a1 1 0 0 0 1.42 0l3.18-3.21a1 1 0 0 0 0-1.39L8.71 4.08a6.12 6.12 0 0 1 1-.08a5.67 5.67 0 0 1 5.66 5.67a5.88 5.88 0 0 1-.2 1.48a1 1 0 0 0 .26.95l4.9 4.9a1 1 0 0 0 1.42-1.42Z"/></svg>
                <span>Skills:</span>
              </div>
              {skills.map((skill) => (
                <span class="skill-list-item" role="listitem">
                  {skill}
                </span>
              ))}
            </span>
          </span>
        )
      }
    </div>
  </Fragment>
  <Fragment slot="right-side">
    <h4 class="text-xl font-medium mb-5 font-display print:font-serif print:font-bold">Description</h4>
    <ul class="flex flex-col gap-2" role="list">
      <BulletPoints items={bulletPoints} />
    </ul>
  </Fragment>
</ResumeCardGrid>

<style lang="scss">
  .skill-list-item:not(:last-child):after {
    content: "·";
    display: inline-block;
  }
</style>

<script>
  (async () => {
    const { setupScript } = await import("~/scripts/setupScript");
    const { setupTimeDifferenceWrapper } = await import("~/scripts/Elements/TimeDifferenceWrapper");
    
    await setupScript({
      name: "webcomponent-time-difference-wrapper",
      setup: setupTimeDifferenceWrapper,
      once: true
    });
  })();
</script>
